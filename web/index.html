
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Camera manager</title>
  <style>
    body { font-family: sans-serif; }
    .cam { padding:4px; margin:2px; }
    .active { color: green; }
    .inactive { color: gray; }
    .newcam { padding:4px; margin:2px; }
  </style>
</head>
<body>
  <h3>Configured cameras</h3>
  <div id="configured"></div>
  <h3>New cameras</h3>
  <div id="newcams"></div>
  <script>
    async function refresh(){
      try {
        const configured = await (await fetch('/api/configured', {cache:'no-store'})).json();
        const confDiv = document.getElementById('configured');
        confDiv.innerHTML='';
        configured.forEach(c => {
          const div=document.createElement('div');
          div.className='cam ' + (c.present ? 'active':'inactive');
          const title=document.createElement('span');
          title.textContent=c.id+' ';
          div.appendChild(title);
          let preview;
          if(c.preview && c.present){
            preview=document.createElement('img');
            preview.width=320; preview.height=240;
            preview.src=`/api/preview?id=${encodeURIComponent(c.id)}&t=${Date.now()}`;
          }else{
            preview=document.createElement('div');
            preview.style.width='320px';
            preview.style.height='240px';
            preview.style.display='flex';
            preview.style.alignItems='center';
            preview.style.justifyContent='center';
            preview.style.background='#ddd';
            preview.textContent = c.present ? 'камера подключена' : 'нет камеры';
          }
          div.appendChild(preview);
          const toggle=document.createElement('button');
          toggle.textContent=c.preview?'Disable preview':'Enable preview';
          toggle.onclick=async()=>{
            await fetch('/api/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id,enable:!c.preview})});
            refresh();
          };
          div.appendChild(toggle);
          const del=document.createElement('button');
          del.textContent='Delete';
          del.onclick=async()=>{
            await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id})});
            refresh();
          };
          div.appendChild(del);
          confDiv.appendChild(div);
        });
        const news = await (await fetch('/api/new', {cache:'no-store'})).json();
        const newDiv = document.getElementById('newcams');
        newDiv.innerHTML='';
        news.forEach(n => {
          const div=document.createElement('div');
          div.className='newcam';
          const title=document.createElement('span');
          title.textContent=n+' ';
          div.appendChild(title);
          const img=document.createElement('img');
          img.width=320; img.height=240;
          img.src=`/api/preview?by=${encodeURIComponent(n)}&t=${Date.now()}`;
          div.appendChild(img);
          const btn=document.createElement('button');
          btn.textContent='Add';
          btn.onclick=async()=>{
            const id=prompt('Enter camera id');
            if(!id) return;
            await fetch('/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id,by_id:n})});
          };
          div.appendChild(btn);
          newDiv.appendChild(div);
        });
      } catch(e){}
    }
    setInterval(refresh,1000);
    refresh();
  </script>
</body>
</html>
