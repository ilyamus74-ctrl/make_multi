<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Camera manager</title>
  <style>
    body { font-family: sans-serif; }
    .cam { padding:4px; margin:2px; }
    .active { color: green; }
    .inactive { color: gray; }
    .newcam { padding:4px; margin:2px; }
    .tab { display:none; }
    .tab.active { display:block; }
    #adv-settings { margin-top:8px; padding:6px; background:#eee; display:none; }
  </style>
</head>
<body>
  <div>
    <button id="tabbtn-main">main</button>
    <button id="tabbtn-settings">settings</button>
  </div>

  <div id="tab-main" class="tab active">
    <h3>Main</h3>
    <div>Placeholder</div>
  </div>

  <div id="tab-settings" class="tab">
    <h3>Configured cameras</h3>
    <div id="configured"></div>

    <!-- Persistent advanced-settings panel -->
    <div id="adv-settings"></div>

    <h3>New cameras</h3>
    <div id="newcams"></div>
  </div>

  <script>
    function showTab(id){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    document.getElementById('tabbtn-main').onclick=()=>showTab('tab-main');
    document.getElementById('tabbtn-settings').onclick=()=>showTab('tab-settings');

    let currentAdvId=null;
    let advDirty=false;

    function showAdvSettings(cam){
      currentAdvId = cam.id;
      advDirty = false;
      const advDiv=document.getElementById('adv-settings');
      advDiv.style.display='block';
      advDiv.innerHTML='';
      advDiv.appendChild(document.createTextNode('Дополнительные настройки '+cam.id));
      advDiv.appendChild(document.createElement('br'));

      const w=document.createElement('input'); w.type='number'; w.value=cam.preferred.w;
      const h=document.createElement('input'); h.type='number'; h.value=cam.preferred.h;
      const pix=document.createElement('input'); pix.value=cam.preferred.pixfmt;
      const fps=document.createElement('input'); fps.type='number'; fps.value=cam.preferred.fps;
      const worker=document.createElement('input'); worker.type='number'; worker.value=cam.npu_worker;
      const auto=document.createElement('input'); auto.type='checkbox'; auto.checked=cam.auto_profiles;

      [w,h,pix,fps,worker,auto].forEach(el=>el.addEventListener('input',()=>advDirty=true));

      advDiv.appendChild(document.createTextNode('w:')); advDiv.appendChild(w);
      advDiv.appendChild(document.createTextNode(' h:')); advDiv.appendChild(h);
      advDiv.appendChild(document.createTextNode(' pixfmt:')); advDiv.appendChild(pix);
      advDiv.appendChild(document.createTextNode(' fps:')); advDiv.appendChild(fps);
      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(document.createTextNode('npu_worker:')); advDiv.appendChild(worker);
      advDiv.appendChild(document.createTextNode(' auto_profiles:')); advDiv.appendChild(auto);

      const apply=document.createElement('button');
      apply.textContent='Apply';
      apply.onclick=async()=>{
        await fetch('/api/settings',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            id:cam.id,
            preferred:{w:parseInt(w.value),h:parseInt(h.value),pixfmt:pix.value,fps:parseInt(fps.value)},
            npu_worker:parseInt(worker.value),
            auto_profiles:auto.checked})
        });
        advDirty=false;
        refresh();
      };
      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(apply);
    }

    async function refresh(){
      if(!document.getElementById('tab-settings').classList.contains('active')) return;
      try{
        const configured = await (await fetch('/api/configured',{cache:'no-store'})).json();
        const confDiv=document.getElementById('configured');
        confDiv.innerHTML='';
        configured.forEach(c=>{
          const div=document.createElement('div');
          div.className='cam '+(c.present?'active':'inactive');
          const title=document.createElement('span');
          title.textContent=c.id+' ';
          div.appendChild(title);

          let preview;
          if(c.preview && c.present){
            preview=document.createElement('img');
            preview.width=320; preview.height=240;
            preview.src=`/api/preview?id=${encodeURIComponent(c.id)}&t=${Date.now()}`;
          }else{
            preview=document.createElement('div');
            preview.style.width='320px';
            preview.style.height='240px';
            preview.style.display='flex';
            preview.style.alignItems='center';
            preview.style.justifyContent='center';
            preview.style.background='#ddd';
            preview.textContent=c.present?'камера подключена':'нет камеры';
          }
          div.appendChild(preview);

          const toggle=document.createElement('button');
          toggle.textContent=c.preview?'Disable preview':'Enable preview';
          toggle.onclick=async()=>{await fetch('/api/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id,enable:!c.preview})});refresh();};
          div.appendChild(toggle);

          const del=document.createElement('button');
          del.textContent='Delete';
          del.onclick=async()=>{await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id})});refresh();};
          div.appendChild(del);

          const advBtn=document.createElement('button');
          advBtn.textContent='Дополнительные настройки';
          advBtn.onclick=()=>showAdvSettings(c);
          div.appendChild(advBtn);

          confDiv.appendChild(div);
        });

        if(currentAdvId && !advDirty){
          const cam=configured.find(c=>c.id===currentAdvId);
          if(cam) showAdvSettings(cam); else {
            document.getElementById('adv-settings').style.display='none';
            currentAdvId=null;
          }
        }

        const news = await (await fetch('/api/new',{cache:'no-store'})).json();
        const newDiv=document.getElementById('newcams');
        newDiv.innerHTML='';
        news.forEach(n=>{
          const div=document.createElement('div');
          div.className='newcam';
          const title=document.createElement('span');
          title.textContent=n+' ';
          div.appendChild(title);
          const img=document.createElement('img');
          img.width=320; img.height=240;
          img.src=`/api/preview?by=${encodeURIComponent(n)}&t=${Date.now()}`;
          div.appendChild(img);
          const btn=document.createElement('button');
          btn.textContent='Add';
          btn.onclick=async()=>{const id=prompt('Enter camera id'); if(!id) return; await fetch('/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id,by_id:n})});};
          div.appendChild(btn);
          newDiv.appendChild(div);
        });

      }catch(e){}
    }
    setInterval(refresh,1000);
    refresh();
  </script>
</body>
</html>
