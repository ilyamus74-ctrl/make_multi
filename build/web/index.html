<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Camera manager</title>
  <style>
    body { font-family: sans-serif; }
    .cam { padding:4px; margin:2px; }
    .active { color: green; }
    .inactive { color: gray; }
    .newcam { padding:4px; margin:2px; }
    .tab { display:none; }
    .tab.active { display:block; }
    #adv-settings { margin-top:8px; padding:6px; background:#eee; display:none; }
  </style>
</head>
<body>
  <div>
    <button id="tabbtn-main">main</button>
    <button id="tabbtn-settings">settings</button>
  </div>

  <div id="tab-main" class="tab active">
    <h3>Main</h3>
    <div>Placeholder</div>
  </div>

  <div id="tab-settings" class="tab">
    <h3>Configured cameras</h3>
    <div id="configured"></div>

    <!-- Persistent advanced-settings panel -->
    <div id="adv-settings"></div>

    <h3>New cameras</h3>
    <div id="newcams"></div>
  </div>

  <script>
    function showTab(id){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    document.getElementById('tabbtn-main').onclick=()=>showTab('tab-main');
    document.getElementById('tabbtn-settings').onclick=()=>showTab('tab-settings');

    let currentAdvId=null;
    let advDirty=false;
    let previewEnabled=false;
    const previewTimers=new Map();

    function showAdvSettings(cam){
      currentAdvId = cam.id;
      advDirty = false;
      const advDiv=document.getElementById('adv-settings');
      advDiv.style.display='block';
      advDiv.innerHTML='';
      advDiv.appendChild(document.createTextNode('Дополнительные настройки '+cam.id));
      advDiv.appendChild(document.createElement('br'));

      const w=document.createElement('input'); w.type='number'; w.value=cam.preferred.w;
      const h=document.createElement('input'); h.type='number'; h.value=cam.preferred.h;
      const pix=document.createElement('input'); pix.value=cam.preferred.pixfmt;
      const fps=document.createElement('input'); fps.type='number'; fps.value=cam.preferred.fps;
      const worker=document.createElement('input'); worker.type='number'; worker.value=cam.npu_worker;
      const auto=document.createElement('input'); auto.type='checkbox'; auto.checked=cam.auto_profiles;
      const profile=document.createElement('select');
      ['auto','bright','indoor','dark'].forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;if(cam.profile===p)o.selected=true;profile.appendChild(o);});

      [w,h,pix,fps,worker,auto,profile].forEach(el=>{
        el.addEventListener('focus',()=>advDirty=true);
        el.addEventListener('input',()=>advDirty=true);
      });

      advDiv.appendChild(document.createTextNode('w:')); advDiv.appendChild(w);
      advDiv.appendChild(document.createTextNode(' h:')); advDiv.appendChild(h);
      advDiv.appendChild(document.createTextNode(' pixfmt:')); advDiv.appendChild(pix);
      advDiv.appendChild(document.createTextNode(' fps:')); advDiv.appendChild(fps);
      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(document.createTextNode('npu_worker:')); advDiv.appendChild(worker);
      advDiv.appendChild(document.createTextNode(' use_profiles:')); advDiv.appendChild(auto);
      advDiv.appendChild(document.createTextNode(' profile:')); advDiv.appendChild(profile);

      const apply=document.createElement('button');
      apply.textContent='Apply';
      apply.onclick=async()=>{
        await fetch('/api/settings',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            id:cam.id,
            preferred:{w:parseInt(w.value),h:parseInt(h.value),pixfmt:pix.value,fps:parseInt(fps.value)},
            npu_worker:parseInt(worker.value),
            auto_profiles:auto.checked,
            profile:profile.value}) 
       });
        advDirty=false;
        refresh();
      };
      const reset=document.createElement('button');
      reset.textContent='Reset';
      reset.onclick=async()=>{
        await fetch('/api/settings/reset',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({id:cam.id})
        });
        advDirty=false;
        refresh();
      };

      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(apply);
      advDiv.appendChild(reset);
    }

    async function refresh(){
      if(!document.getElementById('tab-settings').classList.contains('active')) return;
      try{
        const configured = await (await fetch('/api/configured',{cache:'no-store'})).json();
        const confDiv=document.getElementById('configured');
        const existing=new Map(Array.from(confDiv.querySelectorAll('.cam')).map(d=>[d.dataset.id,d]));
        configured.forEach((c,idx)=>{
          let div=existing.get(c.id);
          if(!div){
            div=document.createElement('div');
            div.className='cam';
            div.dataset.id=c.id;
            const title=document.createElement('span'); title.className='title'; div.appendChild(title);
            const preview=document.createElement('div'); preview.className='preview'; div.appendChild(preview);
            const toggle=document.createElement('button'); toggle.className='toggle'; div.appendChild(toggle);
            const del=document.createElement('button'); del.className='delete'; div.appendChild(del);
            const advBtn=document.createElement('button'); advBtn.className='adv'; advBtn.textContent='Дополнительные настройки';
            div.appendChild(advBtn);
            const fps=document.createElement('span'); fps.className='fps'; div.appendChild(fps);
            confDiv.appendChild(div);
          }
          existing.delete(c.id);
          div.className='cam '+(c.present?'active':'inactive');
          div.querySelector('.title').textContent=c.id+' ';

          let preview=div.querySelector('.preview');
	  if(previewEnabled && c.preview && c.present){
            if(preview.tagName!=='IMG'){
              const img=document.createElement('img');
              img.className='preview';
              img.width=320; img.height=240;
              div.replaceChild(img, preview);
              preview=img;
            }
          }else{
            if(preview.tagName==='IMG'){
              const ph=document.createElement('div');
              ph.className='preview';
              ph.style.width='320px'; ph.style.height='240px';
              ph.style.display='flex'; ph.style.alignItems='center';
              ph.style.justifyContent='center'; ph.style.background='#ddd';
              div.replaceChild(ph, preview);
              preview=ph;
            }
            preview.textContent=c.present?'камера подключена':'нет камеры';
          }

          const id=c.id;
          let timer=previewTimers.get(id);
          if(previewEnabled && c.preview && c.present){
            if(!timer){
              setTimeout(()=>{
                const update=()=>{
                  const img=div.querySelector('img.preview');
                  if(img) img.src=`/api/preview?id=${encodeURIComponent(id)}&t=${Date.now()}`;
                };
                update();
                const t=setInterval(update,1000);
                previewTimers.set(id,t);
              },idx*200);
            }
          }else if(timer){
            clearInterval(timer);
            previewTimers.delete(id);
          }


          const toggle=div.querySelector('button.toggle');
          toggle.textContent=c.preview?'Disable preview':'Enable preview';
          toggle.disabled=!previewEnabled;
          toggle.onclick=async()=>{await fetch('/api/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id,enable:!c.preview})});refresh();};

          const del=div.querySelector('button.delete');
          del.textContent='Delete';
          del.onclick=async()=>{await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id})});refresh();};

          const advBtn=div.querySelector('button.adv');
          advBtn.onclick=()=>showAdvSettings(c);
          const fps=div.querySelector('span.fps');
          fps.textContent=` FPS: ${c.fps.toFixed(1)}`;
        });
	existing.forEach(div=>{
          const t=previewTimers.get(div.dataset.id);
          if(t){clearInterval(t);previewTimers.delete(div.dataset.id);}
          div.remove();
        });


        if(currentAdvId && !advDirty){
          const cam=configured.find(c=>c.id===currentAdvId);
          if(cam) showAdvSettings(cam); else {
            document.getElementById('adv-settings').style.display='none';
            currentAdvId=null;
          }
        }

        const news = await (await fetch('/api/new',{cache:'no-store'})).json();
        const newDiv=document.getElementById('newcams');
        newDiv.innerHTML='';
	news.forEach((n,idx)=>{
          const div=document.createElement('div');
          div.className='newcam';
          const title=document.createElement('span');
          title.textContent=n+' ';
          div.appendChild(title);
          const img=document.createElement('img');
          img.width=320; img.height=240;
	  if(previewEnabled)
          setTimeout(()=>{img.src=`/api/preview?by=${encodeURIComponent(n)}&t=${Date.now()}`;},idx*200);
          div.appendChild(img);
          const btn=document.createElement('button');
          btn.textContent='Add';
          btn.onclick=async()=>{const id=prompt('Enter camera id'); if(!id) return; await fetch('/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id,by_id:n})});};
          div.appendChild(btn);
          newDiv.appendChild(div);
        });

      }catch(e){}
    }
    setInterval(refresh,1000);
    fetch('/api/config',{cache:'no-store'}).then(r=>r.json()).then(c=>{previewEnabled=c.preview_enabled; refresh();});
  </script>
</body>
</html>

