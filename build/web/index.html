<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Camera manager</title>
  <style>
    body { font-family: sans-serif; }
    .cam { padding:4px; margin:2px; }
    .active { color: green; }
    .inactive { color: gray; }
    .newcam { padding:4px; margin:2px; }
    .tab { display:none; }
    .tab.active { display:block; }
    #adv-settings { margin-top:8px; padding:6px; background:#eee; display:none; }
  </style>
</head>
<body>
  <div>
    <button id="tabbtn-main">main</button>
    <button id="tabbtn-settings">settings</button>
  </div>

  <div id="tab-main" class="tab active">
    <h3>Main</h3>
    <div id="mosaic" style="display:grid;gap:4px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));"></div>
  </div>

  <div id="tab-settings" class="tab">
    <h3>Configured cameras <button onclick="showStereoSettings()">Stereo Settings</button></h3>
    <div id="configured"></div>

    <!-- Persistent advanced-settings panel -->
    <div id="adv-settings" data-loaded="0"></div>
    <div id="stereo-settings" style="display:none;position:fixed;top:10%;left:10%;background:#fff;border:1px solid #888;padding:10px;"></div>

    <h3>New cameras</h3>
    <div id="newcams"></div>
  </div>

  <script>
    function showTab(id){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      if(id==='tab-main'){
        startMain();
      }else{
        stopMain();
        if(id==='tab-settings'){
          const advDiv=document.getElementById('adv-settings');
          advDiv.style.display='none';
          advDiv.dataset.loaded='0';
          advDiv.innerHTML='';
          currentAdvId=null;
          advDirty=false;
        }
      }
    }
    document.getElementById('tabbtn-main').onclick=()=>showTab('tab-main');
    document.getElementById('tabbtn-settings').onclick=()=>showTab('tab-settings');

    let currentAdvId=null;
    let advDirty=false;
    let previewEnabled=false;
    const previewTimers=new Map();


    async function showStereoSettings(){
      const panel=document.getElementById('stereo-settings');
      panel.style.display='block';
      panel.innerHTML='Loading...';
      let cams=[];
      try{
        cams=await (await fetch('/api/configured',{cache:'no-store'})).json();
      }catch(e){}
      panel.innerHTML='';


      // camera selection
      const sel=document.createElement('select'); sel.id='calib-camera';
      cams.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.id;sel.appendChild(o);});
      panel.appendChild(document.createTextNode('camera:'));
      panel.appendChild(sel);

      const save=document.createElement('button');
      save.textContent='Save';
      panel.appendChild(save);

      const mono=document.createElement('button'); mono.textContent='Mono calibr'; mono.id='mono-calib'; mono.disabled=true; panel.appendChild(mono);
      const stereo=document.createElement('button'); stereo.textContent='Stereo calibr'; stereo.id='stereo-calib'; stereo.disabled=true; panel.appendChild(stereo);
      const close=document.createElement('button'); close.textContent='Close'; close.onclick=()=>{panel.style.display='none';}; panel.appendChild(close);

      async function refreshButtons(){
        let st={};
        try{ st=await (await fetch('/api/calib/status',{cache:'no-store'})).json(); }catch(e){}
        mono.disabled=!(st.folder_exists && !st.mono_done);
        stereo.disabled=!(st.stereo_ready);
      }

      save.onclick=async()=>{
        await fetch('/api/calib/setup',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({camera:sel.value})
        });
        await refreshButtons();
      };
      mono.onclick=async()=>{
        mono.disabled=true;
        await fetch('/api/calib/mono',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({camera:sel.value})
        });
        await refreshButtons();
      };


      stereo.onclick=async()=>{
        stereo.disabled=true;
        await fetch('/api/calibrate/stereo-auto',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({camera:sel.value})
        });
        await refreshButtons();
      };
      await refreshButtons();
    }

// ----- Main tab detection stream -----
    let mainCams=[];
    let detTimer=null;
    let globalNextId=1;
    const globalObjs=new Map();
    function startMain(){
      refreshMain();
      if(detTimer) clearInterval(detTimer);
      detTimer=setInterval(fetchDetections,1000);
    }
    function stopMain(){
      if(detTimer){clearInterval(detTimer);detTimer=null;}
    }
    async function refreshMain(){
      const cams=await (await fetch('/api/configured',{cache:'no-store'})).json();
      mainCams=cams.filter(c=>c.det_running);
      const mosaic=document.getElementById('mosaic');
      mosaic.innerHTML='';
      mainCams.forEach(c=>{
        const img=document.createElement('img');
        img.width=320; img.height=240;
        img.src=`${location.protocol}//${location.hostname}:${c.det_port}/api/stream.mjpg`;
        mosaic.appendChild(img);
      });
    }
    function colorDist(a,b){return Math.abs(a[0]-b[0])+Math.abs(a[1]-b[1])+Math.abs(a[2]-b[2]);}
    async function fetchDetections(){
      for(const cam of mainCams){
        try{
          const j=await (await fetch(`${location.protocol}//${location.hostname}:${cam.det_port}/api/last.json`)).json();
          if(!j.detections) continue;
          j.detections.forEach(det=>{
            if(!det.color) return;
            let best=null; let bestd=1e9;
            globalObjs.forEach((obj,id)=>{const d=colorDist(obj.color,det.color); if(d<bestd){bestd=d; best=id;}});
            if(best===null || bestd>30){best=globalNextId++; globalObjs.set(best,{color:det.color,cams:new Map()});}
            const obj=globalObjs.get(best);
            const cx=det.normalized_box.left + det.normalized_box.width/2;
            obj.cams.set(cam.id,{cx:cx, cam:cam});
            if(obj.cams.size>=2){ const arr=[...obj.cams.values()]; obj.distance=triangulate(arr[0],arr[1]); console.log('Object',best,'distance',obj.distance); }
          });
        }catch(e){ }
      }
    }
    function triangulate(a,b){
      const baseline=Math.hypot(a.cam.position.x-b.cam.position.x, a.cam.position.y-b.cam.position.y);
      const fov=60*Math.PI/180; const focal=0.5/Math.tan(fov/2);
      const disparity=Math.abs(a.cx-b.cx); if(disparity<1e-6) return null;
      return (focal*baseline)/disparity;
    }

    async function showAdvSettings(cam){
      const advDiv=document.getElementById('adv-settings');
      if(currentAdvId===cam.id && advDiv.dataset.loaded==='1'){
        document.getElementById('adv-model').value=cam.model_path;
        document.getElementById('adv-labels').value=cam.labels_path;
        document.getElementById('adv-w').value=cam.preferred.w;
        document.getElementById('adv-h').value=cam.preferred.h;
        document.getElementById('adv-pix').value=cam.preferred.pixfmt;
        document.getElementById('adv-fps').value=cam.preferred.fps;
        document.getElementById('adv-worker').value=cam.npu_worker;
        document.getElementById('adv-auto').checked=cam.auto_profiles;
        document.getElementById('adv-profile').value=cam.profile;
        document.getElementById('adv-capfps').value=cam.cap_fps;
        document.getElementById('adv-buffers').value=cam.buffers;
        document.getElementById('adv-jpegq').value=cam.jpeg_quality;
        document.getElementById('adv-httpfps').value=cam.http_fps_limit;
        document.getElementById('adv-showfps').checked=cam.show_fps;
        document.getElementById('adv-npucore').value=cam.npu_core;
        document.getElementById('adv-logfile').value=cam.log_file;
        return;
      }
      currentAdvId = cam.id;
      advDirty = false;
      advDiv.style.display='block';
      advDiv.dataset.loaded='1';
      advDiv.innerHTML='';
      advDiv.appendChild(document.createTextNode('Дополнительные настройки '+cam.id));
      advDiv.appendChild(document.createElement('br'));

      let models={rknn:[],labels:[]};
      try{ models=await (await fetch('/api/models',{cache:'no-store'})).json(); }catch(e){}

      const modelSel=document.createElement('select'); modelSel.id='adv-model';
      models.rknn.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;if(cam.model_path===m)o.selected=true;modelSel.appendChild(o);});
      const labelsSel=document.createElement('select'); labelsSel.id='adv-labels';
      models.labels.forEach(l=>{const o=document.createElement('option');o.value=l;o.textContent=l;if(cam.labels_path===l)o.selected=true;labelsSel.appendChild(o);});


      const w=document.createElement('input'); w.type='number'; w.value=cam.preferred.w; w.id='adv-w';
      const h=document.createElement('input'); h.type='number'; h.value=cam.preferred.h; h.id='adv-h';
      const pix=document.createElement('input'); pix.value=cam.preferred.pixfmt; pix.id='adv-pix';
      const fps=document.createElement('input'); fps.type='number'; fps.value=cam.preferred.fps; fps.id='adv-fps';
      const worker=document.createElement('input'); worker.type='number'; worker.value=cam.npu_worker; worker.id='adv-worker';
      const auto=document.createElement('input'); auto.type='checkbox'; auto.checked=cam.auto_profiles; auto.id='adv-auto';
      const profile=document.createElement('select'); profile.id='adv-profile';

      ['auto','bright','indoor','dark'].forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;if(cam.profile===p)o.selected=true;profile.appendChild(o);});

      const capfps=document.createElement('input'); capfps.type='number'; capfps.value=cam.cap_fps; capfps.id='adv-capfps';
      const buffers=document.createElement('input'); buffers.type='number'; buffers.value=cam.buffers; buffers.id='adv-buffers';
      const jpegq=document.createElement('input'); jpegq.type='number'; jpegq.value=cam.jpeg_quality; jpegq.id='adv-jpegq';
      const httpfps=document.createElement('input'); httpfps.type='number'; httpfps.value=cam.http_fps_limit; httpfps.id='adv-httpfps';
      const showfps=document.createElement('input'); showfps.type='checkbox'; showfps.checked=cam.show_fps; showfps.id='adv-showfps';
      const npucore=document.createElement('input'); npucore.value=cam.npu_core; npucore.id='adv-npucore';
      const logfile=document.createElement('input'); logfile.value=cam.log_file; logfile.id='adv-logfile';

      [w,h,pix,fps,worker,auto,profile,modelSel,labelsSel,capfps,buffers,jpegq,httpfps,showfps,npucore,logfile].forEach(el=>{
        el.addEventListener('focus',()=>advDirty=true);        el.addEventListener('input',()=>advDirty=true);
        el.addEventListener('change',()=>advDirty=true);
      });

      advDiv.appendChild(document.createTextNode('model:')); advDiv.appendChild(modelSel);
      advDiv.appendChild(document.createTextNode(' labels:')); advDiv.appendChild(labelsSel);
      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(document.createTextNode('w:')); advDiv.appendChild(w);
      advDiv.appendChild(document.createTextNode(' h:')); advDiv.appendChild(h);
      advDiv.appendChild(document.createTextNode(' pixfmt:')); advDiv.appendChild(pix);
      advDiv.appendChild(document.createTextNode(' fps:')); advDiv.appendChild(fps);
      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(document.createTextNode('npu_worker:')); advDiv.appendChild(worker);
      advDiv.appendChild(document.createTextNode(' use_profiles:')); advDiv.appendChild(auto);
      advDiv.appendChild(document.createTextNode(' profile:')); advDiv.appendChild(profile);
      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(document.createTextNode('cap-fps:')); advDiv.appendChild(capfps);
      advDiv.appendChild(document.createTextNode(' buffers:')); advDiv.appendChild(buffers);
      advDiv.appendChild(document.createTextNode(' jpeg-quality:')); advDiv.appendChild(jpegq);
      advDiv.appendChild(document.createTextNode(' http-fps-limit:')); advDiv.appendChild(httpfps);
      advDiv.appendChild(document.createTextNode(' fps:')); advDiv.appendChild(showfps);
      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(document.createTextNode(' npu-core:')); advDiv.appendChild(npucore);
      advDiv.appendChild(document.createTextNode(' log-file:')); advDiv.appendChild(logfile);

      const submitSettings=async()=>{
        await fetch('/api/settings',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            id:cam.id,
            preferred:{w:parseInt(w.value),h:parseInt(h.value),pixfmt:pix.value,fps:parseInt(fps.value)},
            npu_worker:parseInt(worker.value),
            auto_profiles:auto.checked,
            profile:profile.value,
            model_path:modelSel.value,
            labels_path:labelsSel.value,
            cap_fps:parseInt(capfps.value),
            buffers:parseInt(buffers.value),
            jpeg_quality:parseInt(jpegq.value),
            http_fps_limit:parseInt(httpfps.value),
            show_fps:showfps.checked,
            npu_core:npucore.value,
            log_file:logfile.value})
       });
       advDirty=false;
       refresh();
      };

      const apply=document.createElement('button');
      apply.textContent='Apply';
      apply.onclick=submitSettings;
      profile.addEventListener('change',submitSettings);

      const reset=document.createElement('button');
      reset.textContent='Reset';
      reset.onclick=async()=>{
        await fetch('/api/settings/reset',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({id:cam.id})
        });
        advDirty=false;
        refresh();
      };

      advDiv.appendChild(document.createElement('br'));
      advDiv.appendChild(apply);
      advDiv.appendChild(reset);
    }

    async function refresh(){
      if(!document.getElementById('tab-settings').classList.contains('active')) return;
      try{
        const configured = await (await fetch('/api/configured',{cache:'no-store'})).json();
        const confDiv=document.getElementById('configured');
        const existing=new Map(Array.from(confDiv.querySelectorAll('.cam')).map(d=>[d.dataset.id,d]));
        configured.forEach((c,idx)=>{
          let div=existing.get(c.id);
          if(!div){
            div=document.createElement('div');
            div.className='cam';
            div.dataset.id=c.id;
            const title=document.createElement('span'); title.className='title'; div.appendChild(title);
            const preview=document.createElement('div'); preview.className='preview'; div.appendChild(preview);
            const toggle=document.createElement('button'); toggle.className='toggle'; div.appendChild(toggle);
            const del=document.createElement('button'); del.className='delete'; div.appendChild(del);
            const advBtn=document.createElement('button'); advBtn.className='adv'; advBtn.textContent='Дополнительные настройки';
            div.appendChild(advBtn);
            const fps=document.createElement('span'); fps.className='fps'; div.appendChild(fps);
            confDiv.appendChild(div);
          }
          existing.delete(c.id);
          div.className='cam '+(c.present?'active':'inactive');
          div.querySelector('.title').textContent=c.id+' ';

          let preview=div.querySelector('.preview');
	  if(previewEnabled && c.preview && c.present){
            if(preview.tagName!=='IMG'){
              const img=document.createElement('img');
              img.className='preview';
              img.width=320; img.height=240;
              div.replaceChild(img, preview);
              preview=img;
            }
          }else{
            if(preview.tagName==='IMG'){
              const ph=document.createElement('div');
              ph.className='preview';
              ph.style.width='320px'; ph.style.height='240px';
              ph.style.display='flex'; ph.style.alignItems='center';
              ph.style.justifyContent='center'; ph.style.background='#ddd';
              div.replaceChild(ph, preview);
              preview=ph;
            }
            preview.textContent=c.present?'камера подключена':'нет камеры';
          }

          const id=c.id;
          let timer=previewTimers.get(id);
          if(previewEnabled && c.preview && c.present){
            if(!timer){
              setTimeout(()=>{
                const update=()=>{
                  const img=div.querySelector('img.preview');
                  if(img) img.src=`/api/preview?id=${encodeURIComponent(id)}&t=${Date.now()}`;
                };
                update();
                const t=setInterval(update,1000);
                previewTimers.set(id,t);
              },idx*200);
            }
          }else if(timer){
            clearInterval(timer);
            previewTimers.delete(id);
          }


          const toggle=div.querySelector('button.toggle');
          toggle.textContent=c.preview?'Disable preview':'Enable preview';
          toggle.disabled=!previewEnabled;
          toggle.onclick=async()=>{await fetch('/api/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id,enable:!c.preview})});refresh();};

          const del=div.querySelector('button.delete');
          del.textContent='Delete';
          del.onclick=async()=>{await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:c.id})});refresh();};

          const advBtn=div.querySelector('button.adv');
          advBtn.onclick=()=>showAdvSettings(c);
          const fps=div.querySelector('span.fps');
          if(c.show_fps && c.det_running){
            fps.textContent=' FPS: ...';
            fetch(`${location.protocol}//${location.hostname}:${c.det_port}/api/health`,{cache:'no-store'})
              .then(r=>r.json())
              .then(h=>{ fps.textContent=` FPS: ${h.cap_real_fps.toFixed(1)}`; })
              .catch(()=>{ fps.textContent=''; });
          }else{
            fps.textContent='';
          }
        });
	existing.forEach(div=>{
          const t=previewTimers.get(div.dataset.id);
          if(t){clearInterval(t);previewTimers.delete(div.dataset.id);}
          div.remove();
        });


        if(currentAdvId && !advDirty){
          const cam=configured.find(c=>c.id===currentAdvId);
          if(cam) await showAdvSettings(cam); else {
            const advDiv=document.getElementById('adv-settings');
            advDiv.style.display='none';
            advDiv.dataset.loaded='0';
            currentAdvId=null;
          }
        }

        const news = await (await fetch('/api/new',{cache:'no-store'})).json();
        const newDiv=document.getElementById('newcams');
        newDiv.innerHTML='';
	news.forEach((n,idx)=>{
          const div=document.createElement('div');
          div.className='newcam';
          const title=document.createElement('span');
          title.textContent=n+' ';
          div.appendChild(title);
          const img=document.createElement('img');
          img.width=320; img.height=240;
	  if(previewEnabled)
          setTimeout(()=>{img.src=`/api/preview?by=${encodeURIComponent(n)}&t=${Date.now()}`;},idx*200);
          div.appendChild(img);
          const btn=document.createElement('button');
          btn.textContent='Add';
          btn.onclick=async()=>{const id=prompt('Enter camera id'); if(!id) return; await fetch('/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id,by_id:n})});};
          div.appendChild(btn);
          newDiv.appendChild(div);
        });

      }catch(e){}
    }
    setInterval(refresh,1000);
    fetch('/api/config',{cache:'no-store'}).then(r=>r.json()).then(c=>{previewEnabled=c.preview_enabled; refresh();});
  </script>
</body>
</html>

